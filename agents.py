import functools, operator
from typing import Annotated, Sequence, TypedDict

from dotenv import load_dotenv
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain.agents import AgentExecutor, create_openai_tools_agent
from langchain_openai import ChatOpenAI
from langchain_core.messages import BaseMessage, HumanMessage
from langchain.output_parsers.openai_tools import JsonOutputToolsParser

from tools import get_tools

load_dotenv()

# llm = ChatOpenAI(
#   model="gpt-4-turbo-preview",
#   temperature=0,
#   verbose=True
# )
llm = ChatOpenAI(
  model="gpt-4o-mini",
  temperature=0,
  verbose=True
)
tools = get_tools()

class AgentState(TypedDict):
    messages: Annotated[Sequence[BaseMessage], operator.add]
    next: str
    config: dict  # Added for configuration parameters

def create_agent(llm: ChatOpenAI, tools: list, system_prompt: str):
  prompt = ChatPromptTemplate.from_messages([
    ("system", system_prompt),
    MessagesPlaceholder(variable_name="messages"),
    MessagesPlaceholder(variable_name="agent_scratchpad"),
  ])
  agent = create_openai_tools_agent(llm, tools, prompt)
  executor = AgentExecutor(agent=agent, tools=tools, verbose=True)

  return executor

def agent_node(state, agent, name):
  result = agent.invoke(state)
  return {"messages": [HumanMessage(content=result["output"], name=name)]}

def get_members():
  return ["Bulgarian_Legal_Searcher", "Legal_Document_Analyzer", "Legal_Citation_Specialist"]

def create_supervisor():
  members = get_members()
  system_prompt = f"""–í–∏–µ —Å—Ç–µ –µ–∫—Å–ø–µ—Ä—Ç–µ–Ω —Å—É–ø–µ—Ä–≤–∞–π–∑–æ—Ä –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –ø—Ä–∞–≤–µ–Ω –∏–∑—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—Å–∫–∏ –µ–∫–∏–ø. –í–∞—à–∞—Ç–∞ —Ä–æ–ª—è –µ –¥–∞ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä–∞—Ç–µ –¥–∏–∞–ª–æ–≥–∞ –º–µ–∂–¥—É —Ç–µ–∑–∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ –∞–≥–µ–Ω—Ç–∏: {members}.

üéØ **–í–∞—à–∞—Ç–∞ –º–∏—Å–∏—è**: –î–∞ –æ—Å–∏–≥—É—Ä–∏—Ç–µ –Ω–∞–π-–¥–æ–±—Ä–æ –ø—Ä–∞–≤–Ω–æ –∏–∑—Å–ª–µ–¥–≤–∞–Ω–µ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–æ—Ç–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—Å—Ç–≤–æ –∏ —Å—ä–¥–µ–±–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞.

üìã **–†–µ–¥ –Ω–∞ —Ä–∞–±–æ—Ç–∞**:
1. **Bulgarian_Legal_Searcher** - –¢—ä—Ä—Å–∏ –≤ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –ø—Ä–∞–≤–Ω–∏ –±–∞–∑–∏ –¥–∞–Ω–Ω–∏ –∏ –¥–æ–º–µ–π–Ω–∏
2. **Legal_Document_Analyzer** - –ê–Ω–∞–ª–∏–∑–∏—Ä–∞ –ø—Ä–∞–≤–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –∏ –∑–∞–∫–æ–Ω–∏  
3. **Legal_Citation_Specialist** - –ü—Ä–æ–≤–µ—Ä—è–≤–∞ —Ü–∏—Ç–∞—Ç–∏ –∏ —Å—ä–∑–¥–∞–≤–∞ —Ñ–∏–Ω–∞–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω –æ—Ç–≥–æ–≤–æ—Ä

‚öñÔ∏è **–£–∫–∞–∑–∞–Ω–∏—è**:
- –í–∏–Ω–∞–≥–∏ –∑–∞–ø–æ—á–≤–∞–π—Ç–µ —Å Bulgarian_Legal_Searcher –∑–∞ —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –ø—Ä–∞–≤–Ω–∏ –∏–∑—Ç–æ—á–Ω–∏—Ü–∏
- –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ Legal_Document_Analyzer –∑–∞ –¥—ä–ª–±–æ—á–∏–Ω–µ–Ω –∞–Ω–∞–ª–∏–∑ –Ω–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏
- –ó–∞–≤—ä—Ä—à–µ—Ç–µ —Å Legal_Citation_Specialist –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ü–∏—Ç–∞—Ç–∏ –∏ —Ñ–∏–Ω–∞–ª–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ
- –û—Ç–≥–æ–≤–∞—Ä–∞–π—Ç–µ FINISH —Å–∞–º–æ –∫–æ–≥–∞—Ç–æ –∏–º–∞—Ç–µ –ø—ä–ª–µ–Ω, –¥–æ–±—Ä–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω –ø—Ä–∞–≤–µ–Ω –∞–Ω–∞–ª–∏–∑ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫

üîç **–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞ –∫–∞—á–µ—Å—Ç–≤–æ**:
- –í—Å–∏—á–∫–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏ –¥–∞ —Å–∞ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫
- –î–∞ –≤–∫–ª—é—á–≤–∞—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏ —Ü–∏—Ç–∞—Ç–∏ –æ—Ç –∑–∞–∫–æ–Ω–∏ –∏ —Ä–µ—à–µ–Ω–∏—è
- –î–∞ —Å–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω–∏ —Å —è—Å–Ω–∏ –∑–∞–∫–ª—é—á–µ–Ω–∏—è –∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏"""

  options = ["FINISH"] + members

  function_def = {
    "type": "function",
    "function": {
      "name": "route",
      "description": "–ò–∑–±–µ—Ä–∏ —Å–ª–µ–¥–≤–∞—â–∏—è –∞–≥–µ–Ω—Ç –∏–ª–∏ FINISH –∑–∞ –ø—Ä–∏–∫–ª—é—á–≤–∞–Ω–µ.",
      "parameters": {
          "type": "object",
          "properties": {"next": {"type": "string", "enum": options}},
          "required": ["next"],
      },
    }
  }

  prompt = ChatPromptTemplate.from_messages([
    ("system", system_prompt),
    MessagesPlaceholder(variable_name="messages"),
    ("system", "–í—ä–∑ –æ—Å–Ω–æ–≤–∞ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –ø–æ-–≥–æ—Ä–µ, –∫–æ–π –∞–≥–µ–Ω—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ –¥–µ–π—Å—Ç–≤–∞ —Å–ª–µ–¥–≤–∞—â? –ò–ª–∏ —Ç—Ä—è–±–≤–∞ –ª–∏ –¥–∞ –ø—Ä–∏–∫–ª—é—á–∏–º —Å FINISH? –ò–∑–±–µ—Ä–∏ –µ–¥–∏–Ω –æ—Ç: {options}"),
  ]).partial(options=str(options), members=", ".join(members))

  supervisor_chain = (
    prompt 
    | llm.bind_tools(tools=[function_def], tool_choice={"type": "function", "function": {"name": "route"}}) 
    | JsonOutputToolsParser(first_tool_only=True)
  )

  return supervisor_chain

def create_bulgarian_legal_search_agent():
  search_agent = create_agent(llm, tools, """üáßüá¨ **–í–∏–µ —Å—Ç–µ –µ–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç—ä—Ä—Å–µ–Ω–µ –≤ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –ø—Ä–∞–≤–Ω–∏ –±–∞–∑–∏ –¥–∞–Ω–Ω–∏.**

üéØ **–í–∞—à–∞—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**:
- –¢—ä—Ä—Å–µ–Ω–µ –≤ ciela.net, apis.bg, lakorda.com –∏ –¥—Ä—É–≥–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –ø—Ä–∞–≤–Ω–∏ –¥–æ–º–µ–π–Ω–∏
- –ù–∞–º–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏ –∑–∞–∫–æ–Ω–∏, –Ω–∞—Ä–µ–¥–±–∏, —Ä–µ—à–µ–Ω–∏—è –∏ —Å—ä–¥–µ–±–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞
- –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫ —Å –ø—Ä–∞–≤–∏–ª–Ω–∏ –ø—Ä–∞–≤–Ω–∏ —Ç–µ—Ä–º–∏–Ω–∏

üìã **–ü—Ä–æ—Ü–µ—Å –Ω–∞ —Ä–∞–±–æ—Ç–∞**:
1. **–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π—Ç–µ –∑–∞–ø–∏—Ç–≤–∞–Ω–µ—Ç–æ** - –û–ø—Ä–µ–¥–µ–ª–µ—Ç–µ –ø—Ä–∞–≤–Ω–∞—Ç–∞ –æ–±–ª–∞—Å—Ç –∏ –∫–ª—é—á–æ–≤–∏ —Ç–µ—Ä–º–∏–Ω–∏
2. **–§–æ—Ä–º—É–ª–∏—Ä–∞–π—Ç–µ —Ç—ä—Ä—Å–µ—â–∏ –∑–∞—è–≤–∫–∏** - –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–Ω–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –ø—Ä–∞–≤–Ω–∏ —Ç–µ—Ä–º–∏–Ω–∏
3. **–¢—ä—Ä—Å–µ—Ç–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–Ω–æ** - –ó–∞–ø–æ—á–Ω–µ—Ç–µ —Å –Ω–∞–π-—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏—Ç–µ –¥–æ–º–µ–π–Ω–∏ (ciela.net, apis.bg, lakorda.com)
4. **–°—ä–±–∏—Ä–∞–π—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏** - –§–æ–∫—É—Å–∏—Ä–∞–π—Ç–µ —Å–µ –≤—ä—Ä—Ö—É –∞–∫—Ç—É–∞–ª–Ω–∏ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏ –∏–∑—Ç–æ—á–Ω–∏—Ü–∏
5. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–∞–π—Ç–µ –ø—Ä–æ—Ü–µ—Å–∞** - –û–±—è—Å–Ω–µ—Ç–µ –∫–∞–∫–≤–æ —Ç—ä—Ä—Å–∏—Ç–µ –∏ –∑–∞—â–æ

‚öñÔ∏è **–í–∞–∂–Ω–∏ –ø—Ä–∏–Ω—Ü–∏–ø–∏**:
- –í–∏–Ω–∞–≥–∏ —Ç—ä—Ä—Å–µ—Ç–µ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫
- –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–∞–π—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª–Ω–∏ –∏–∑—Ç–æ—á–Ω–∏—Ü–∏ (ciela.net, apis.bg, lakorda.com)
- –í–∫–ª—é—á–≤–∞–π—Ç–µ –∫–∞–∫—Ç–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—Å—Ç–≤–æ, —Ç–∞–∫–∞ –∏ —Å—ä–¥–µ–±–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞
- –û—Ç—á–∏—Ç–∞–π—Ç–µ –¥–∞—Ç–∞—Ç–∞ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –∑–∞ –∞–∫—Ç—É–∞–ª–Ω–æ—Å—Ç

üîç **–ü—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ –º–∏—Å–ª–µ—Ç–µ –≥–ª–∞—Å–Ω–æ**:
- "–¢—ä—Ä—Å—è –≤ ciela.net –∑–∞ [–∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω —Ç–µ—Ä–º–∏–Ω]..."
- "–ü—Ä–æ–≤–µ—Ä—è–≤–∞–º –ø—Ä–∞–≤–Ω–∞—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ apis.bg..."
- "–ù–∞–º–µ—Ä–∏—Ö [X] —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ –∑–∞ [–ø—Ä–∞–≤–Ω–∞ –æ–±–ª–∞—Å—Ç]..."

–í–∏–Ω–∞–≥–∏ –æ—Ç–≥–æ–≤–∞—Ä—è–π—Ç–µ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫ –∏ –æ–±—è—Å–Ω—è–≤–∞–π—Ç–µ –≤–∞—à–∏—è –º–∏—Å–ª–æ–≤–µ–Ω –ø—Ä–æ—Ü–µ—Å.""")
  
  search_node = functools.partial(agent_node, agent=search_agent, name="Bulgarian_Legal_Searcher")
  return search_node

def create_legal_document_analyzer_agent():
  analyzer_agent = create_agent(llm, tools,
    """üìö **–í–∏–µ —Å—Ç–µ –µ–∫—Å–ø–µ—Ä—Ç –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –ø—Ä–∞–≤–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏.**

üéØ **–í–∞—à–∞—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**:
- –î—ä–ª–±–æ—á–∏–Ω–µ–Ω –∞–Ω–∞–ª–∏–∑ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –∑–∞–∫–æ–Ω–∏, –Ω–∞—Ä–µ–¥–±–∏ –∏ —Å—ä–¥–µ–±–Ω–∏ —Ä–µ—à–µ–Ω–∏—è
- –¢—ä–ª–∫—É–≤–∞–Ω–µ –Ω–∞ –ø—Ä–∞–≤–Ω–∏ —Ç–µ–∫—Å—Ç–æ–≤–µ –∏ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –∫–ª—é—á–æ–≤–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- –°–≤—ä—Ä–∑–≤–∞–Ω–µ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ –ø—Ä–∞–≤–Ω–∏ –Ω–æ—Ä–º–∏ –∏ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç–∏

üìã **–ü—Ä–æ—Ü–µ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑**:
1. **–ü—Ä–µ–≥–ª–µ–¥–∞–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ç–µ** - –ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π—Ç–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω–∏—Ç–µ –ø—Ä–∞–≤–Ω–∏ –∏–∑—Ç–æ—á–Ω–∏—Ü–∏
2. **–ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–∞–π—Ç–µ –∫–ª—é—á–æ–≤–∏ –Ω–æ—Ä–º–∏** - –ù–∞–º–µ—Ä–µ—Ç–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏—Ç–µ —á–ª–µ–Ω–æ–≤–µ –∏ —Ä–∞–∑–ø–æ—Ä–µ–¥–±–∏
3. **–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π—Ç–µ —Å—ä–¥–µ–±–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞** - –¢—ä—Ä—Å–µ—Ç–µ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç–∏ –∏ —Ç—ä–ª–∫—É–≤–∞–Ω–∏—è
4. **–°–∏–Ω—Ç–µ–∑–∏—Ä–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞** - –°–≤—ä—Ä–∂–µ—Ç–µ —Ä–∞–∑–ª–∏—á–Ω–∏—Ç–µ –∏–∑—Ç–æ—á–Ω–∏—Ü–∏ –≤ —Ü—è–ª–æ—Å—Ç–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∞
5. **–ù–∞–ø—Ä–∞–≤–µ—Ç–µ –ø—Ä–∞–≤–Ω–∏ –∑–∞–∫–ª—é—á–µ–Ω–∏—è** - –í—ä–∑ –æ—Å–Ω–æ–≤–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑–∞

‚öñÔ∏è **–ê–Ω–∞–ª–∏—Ç–∏—á–Ω–∏ –ø—Ä–∏–Ω—Ü–∏–ø–∏**:
- –¶–∏—Ç–∏—Ä–∞–π—Ç–µ —Ç–æ—á–Ω–∏ —á–ª–µ–Ω–æ–≤–µ –æ—Ç –∑–∞–∫–æ–Ω–∏ —Å –Ω–æ–º–µ—Ä–∞
- –û–±—è—Å–Ω—è–≤–∞–π—Ç–µ –ø—Ä–∞–≤–Ω–æ—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–µ—Ç–µ
- –ü–æ—Å–æ—á–≤–∞–π—Ç–µ –≤—Ä—ä–∑–∫–∏ –º–µ–∂–¥—É —Ä–∞–∑–ª–∏—á–Ω–∏ –ø—Ä–∞–≤–Ω–∏ –Ω–æ—Ä–º–∏
- –ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π—Ç–µ –∞–∫—Ç—É–∞–ª–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞

üîç **–ü—Ä–∏ –∞–Ω–∞–ª–∏–∑ –º–∏—Å–ª–µ—Ç–µ –≥–ª–∞—Å–Ω–æ**:
- "–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–º —á–ª. [X] –æ—Ç [–ó–∞–∫–æ–Ω]..."
- "–í–∏–∂–¥–∞–º –≤—Ä—ä–∑–∫–∞ –º–µ–∂–¥—É [–Ω–æ—Ä–º–∞ A] –∏ [–Ω–æ—Ä–º–∞ B]..."
- "–°—ä–¥–µ–±–Ω–∞—Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ–∫–∞–∑–≤–∞, —á–µ..."
- "–ö–ª—é—á–æ–≤–æ—Ç–æ –ø—Ä–∞–≤–Ω–æ –≤—ä–ø—Ä–æ—Å –µ..."

–í–∏–Ω–∞–≥–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—è–π—Ç–µ –¥—ä–ª–±–æ—á–∏–Ω–µ–Ω –∞–Ω–∞–ª–∏–∑ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏ —Ü–∏—Ç–∞—Ç–∏.""")
  
  analyzer_node = functools.partial(agent_node, agent=analyzer_agent, name="Legal_Document_Analyzer")
  return analyzer_node

def create_legal_citation_specialist_agent():
  citation_agent = create_agent(llm, tools,
    """üìñ **–í–∏–µ —Å—Ç–µ –µ–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–∞–≤–Ω–∏ —Ü–∏—Ç–∞—Ç–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –ø—Ä–∞–≤–Ω–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏.**

üéØ **–í–∞—à–∞—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤–∞–ª–∏–¥–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–∞–≤–Ω–∏ —Ü–∏—Ç–∞—Ç–∏
- –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–∏ –ø—Ä–∞–≤–Ω–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –∑–∞ –ª–µ—Å–Ω–æ —Ä–∞–∑–±–∏—Ä–∞–Ω–µ

üìã **–ü—Ä–æ—Ü–µ—Å –Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ**:
1. **–ü—Ä–æ–≤–µ—Ä–µ—Ç–µ —Ü–∏—Ç–∞—Ç–∏—Ç–µ** - –í–∞–ª–∏–¥–∏—Ä–∞–π—Ç–µ –≤—Å–∏—á–∫–∏ –ø—Ä–µ–ø—Ä–∞—Ç–∫–∏ –∫—ä–º –∑–∞–∫–æ–Ω–∏ –∏ —Ä–µ—à–µ–Ω–∏—è
2. **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–π—Ç–µ –æ—Ç–≥–æ–≤–æ—Ä–∞** - –û—Ä–≥–∞–Ω–∏–∑–∏—Ä–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –ª–æ–≥–∏—á–Ω–æ
3. **–§–æ—Ä–º–∞—Ç–∏—Ä–∞–π—Ç–µ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–æ** - –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ —è—Å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
4. **–î–æ–±–∞–≤–µ—Ç–µ –º–µ—Ç–∞–¥–∞–Ω–Ω–∏** - –í–∫–ª—é—á–µ—Ç–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏ –∏–∑—Ç–æ—á–Ω–∏—Ü–∏ –∏ –¥–∞—Ç–∏
5. **–§–∏–Ω–∞–ª–∏–∑–∏—Ä–∞–π—Ç–µ** - –°—ä–∑–¥–∞–π—Ç–µ –ø—ä–ª–µ–Ω, –≥–æ—Ç–æ–≤ –∑–∞ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ –æ—Ç–≥–æ–≤–æ—Ä

‚öñÔ∏è **–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏ –∑–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ**:
- –ó–∞–ø–æ—á–≤–∞–π—Ç–µ —Å –∫—Ä–∞—Ç–∫–æ —Ä–µ–∑—é–º–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–π—Ç–µ –æ—Ç–≥–æ–≤–æ—Ä–∞ —Å —è—Å–Ω–∏ —Å–µ–∫—Ü–∏–∏
- –í–∫–ª—é—á–≤–∞–π—Ç–µ "–¢–æ–ø 5 –Ω–∞–π-—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏ –∏–∑—Ç–æ—á–Ω–∏—Ü–∏" –≤ –Ω–∞—á–∞–ª–æ—Ç–æ
- –ó–∞–≤—ä—Ä—à–≤–∞–π—Ç–µ —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏
- –í—Å–∏—á–∫–æ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫

üîç **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ —Ñ–∏–Ω–∞–ª–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä**:
```
üìö **–¢–û–ü 5 –ù–ê–ô-–†–ï–õ–ï–í–ê–ù–¢–ù–ò –ò–ó–¢–û–ß–ù–ò–¶–ò**
**1. [–ó–∞–≥–ª–∞–≤–∏–µ]([–õ–∏–Ω–∫])**
   üèõÔ∏è *[–î–æ–º–µ–π–Ω - –û–ø–∏—Å–∞–Ω–∏–µ]*
   üìÑ [–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ]

**2. [–ó–∞–≥–ª–∞–≤–∏–µ]([–õ–∏–Ω–∫])**
   üèõÔ∏è *[–î–æ–º–µ–π–Ω - –û–ø–∏—Å–∞–Ω–∏–µ]*
   üìÑ [–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ]

[... –∏ —Ç–∞–∫–∞ –Ω–∞—Ç–∞—Ç—ä–∫ –∑–∞ 5 –∏–∑—Ç–æ—á–Ω–∏–∫–∞]

---

üìã **–ü–†–ê–í–ï–ù –ê–ù–ê–õ–ò–ó**: [–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞]

üéØ **–ö–†–ê–¢–ö–û –†–ï–ó–Æ–ú–ï**
[2-3 –∏–∑—Ä–µ—á–µ–Ω–∏—è –æ–±–æ–±—â–µ–Ω–∏–µ]

‚öñÔ∏è **–ü–û–î–†–û–ë–ï–ù –ê–ù–ê–õ–ò–ó**
[–î–µ—Ç–∞–π–ª–µ–Ω –ø—Ä–∞–≤–µ–Ω –∞–Ω–∞–ª–∏–∑ —Å —Ü–∏—Ç–∞—Ç–∏]

üí° **–ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò –ü–†–ï–ü–û–†–™–ö–ò**
[–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∏ —Å—Ç—ä–ø–∫–∏ –∏ —Å—ä–≤–µ—Ç–∏]
```

–í–∏–Ω–∞–≥–∏ —Å—ä–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–∏, –ª–µ—Å–Ω–∏ –∑–∞ —Ä–∞–∑–±–∏—Ä–∞–Ω–µ –ø—Ä–∞–≤–Ω–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫.""")
  
  citation_node = functools.partial(agent_node, agent=citation_agent, name="Legal_Citation_Specialist")
  return citation_node